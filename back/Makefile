# ============================================
# Makefile para PlantCare Backend
# ============================================
# Simplifica comandos comunes de Docker

.PHONY: help build up down restart logs shell db-shell redis-cli clean rebuild

# Variables
COMPOSE = docker-compose
COMPOSE_DEV = docker-compose -f docker-compose.yml -f docker-compose.dev.yml

# ============================================
# Comandos Principales
# ============================================

help: ## Mostrar esta ayuda
	@echo "üå± PlantCare Backend - Comandos disponibles:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

build: ## Construir im√°genes Docker
	$(COMPOSE) build

up: ## Iniciar servicios (producci√≥n)
	$(COMPOSE) up -d
	@echo "‚úÖ Servicios iniciados"
	@echo "üìä Backend: http://localhost:8000/docs"
	@echo "üíæ PostgreSQL: localhost:5432"
	@echo "üî¥ Redis: localhost:6379"

up-dev: ## Iniciar servicios (desarrollo con hot reload)
	$(COMPOSE_DEV) up -d
	@echo "‚úÖ Servicios iniciados en modo desarrollo"
	@echo "üìä Backend: http://localhost:8000/docs"

down: ## Detener servicios
	$(COMPOSE) down
	@echo "‚èπÔ∏è  Servicios detenidos"

restart: ## Reiniciar servicios
	$(COMPOSE) restart
	@echo "üîÑ Servicios reiniciados"

logs: ## Ver logs de todos los servicios
	$(COMPOSE) logs -f

logs-app: ## Ver logs solo del backend
	$(COMPOSE) logs -f app

logs-db: ## Ver logs de PostgreSQL
	$(COMPOSE) logs -f postgres

logs-redis: ## Ver logs de Redis
	$(COMPOSE) logs -f redis

# ============================================
# Acceso a Contenedores
# ============================================

shell: ## Acceder al shell del backend
	$(COMPOSE) exec app bash

db-shell: ## Acceder a PostgreSQL shell
	$(COMPOSE) exec postgres psql -U postgres -d plantcare_db

redis-cli: ## Acceder a Redis CLI
	$(COMPOSE) exec redis redis-cli

# ============================================
# Base de Datos
# ============================================

db-init: ## Inicializar base de datos
	$(COMPOSE) exec app python -c "from app.api.core.database import init_db; import asyncio; asyncio.run(init_db())"

db-backup: ## Hacer backup de la base de datos
	@mkdir -p backups
	$(COMPOSE) exec postgres pg_dump -U postgres plantcare_db > backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ Backup creado en backups/"

db-restore: ## Restaurar backup (uso: make db-restore FILE=backup.sql)
	@if [ -z "$(FILE)" ]; then \
		echo "‚ùå Especifica el archivo: make db-restore FILE=backups/backup.sql"; \
		exit 1; \
	fi
	$(COMPOSE) exec -T postgres psql -U postgres plantcare_db < $(FILE)
	@echo "‚úÖ Backup restaurado"

# ============================================
# Redis
# ============================================

redis-flush: ## Limpiar todo el cache de Redis
	@echo "‚ö†Ô∏è  Limpiando cache de Redis..."
	$(COMPOSE) exec redis redis-cli FLUSHALL
	@echo "‚úÖ Cache limpiado"

redis-keys: ## Ver todas las keys en Redis
	$(COMPOSE) exec redis redis-cli KEYS '*'

redis-info: ## Ver informaci√≥n de Redis
	$(COMPOSE) exec redis redis-cli INFO

# ============================================
# Limpieza
# ============================================

clean: ## Limpiar contenedores e im√°genes (sin vol√∫menes)
	$(COMPOSE) down --rmi local
	@echo "üßπ Limpieza completada"

clean-all: ## ‚ö†Ô∏è Limpiar TODO incluyendo vol√∫menes (elimina datos)
	@echo "‚ö†Ô∏è  ADVERTENCIA: Esto eliminar√° TODOS los datos"
	@read -p "¬øEst√°s seguro? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		$(COMPOSE) down -v --rmi all; \
		echo "üßπ Limpieza completa"; \
	else \
		echo "‚ùå Cancelado"; \
	fi

rebuild: ## Reconstruir im√°genes y reiniciar
	$(COMPOSE) build --no-cache
	$(COMPOSE) up -d
	@echo "‚úÖ Reconstrucci√≥n completada"

# ============================================
# Desarrollo
# ============================================

dev: up-dev logs-app ## Iniciar en modo desarrollo y ver logs

test: ## Ejecutar tests (si existen)
	$(COMPOSE) exec app python -m pytest

lint: ## Ejecutar linter (si est√° configurado)
	$(COMPOSE) exec app python -m flake8 app/

format: ## Formatear c√≥digo (si black est√° instalado)
	$(COMPOSE) exec app python -m black app/

# ============================================
# Estado y Health Checks
# ============================================

ps: ## Ver estado de servicios
	$(COMPOSE) ps

status: ## Ver estado detallado con health checks
	@echo "üìä Estado de servicios:"
	@$(COMPOSE) ps
	@echo ""
	@echo "üè• Health Checks:"
	@docker inspect plantcare-backend --format='Backend: {{.State.Health.Status}}' 2>/dev/null || echo "Backend: no disponible"
	@docker inspect plantcare-postgres --format='PostgreSQL: {{.State.Health.Status}}' 2>/dev/null || echo "PostgreSQL: no disponible"
	@docker inspect plantcare-redis --format='Redis: {{.State.Health.Status}}' 2>/dev/null || echo "Redis: no disponible"

health: ## Verificar health del backend
	@curl -s http://localhost:8000/api/health | python -m json.tool || echo "‚ùå Backend no responde"

# ============================================
# Por defecto
# ============================================

.DEFAULT_GOAL := help
